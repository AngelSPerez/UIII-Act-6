{% extends "base.html" %}

{% block content %}
<h3>Registrar Nueva Venta Completa</h3>

<form method="post">
    {% csrf_token %}

    <div class="row">
        <div class="col-md-4">
            <h4>1. InformaciÃ³n General</h4>
            <div class="mb-3">
                <label class="form-label">Fecha de Venta</label>
                <input type="text" name="fecha_venta_display" class="form-control" value="{% now "Y-m-d H:i" %}" readonly>
                <div class="form-text">La fecha se registrarÃ¡ al momento de guardar.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Cliente (*)</label>
                <select name="cliente_id" id="cliente-select" class="form-control" required>
                    <option value="">Seleccione un cliente...</option>
                    <option value="anonimo">AnÃ³nimo</option>
                    <option value="otro">Otro (Especifique)</option>
                    <option value="" disabled>--- Clientes Registrados ---</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.id }}">{{ cliente.nombre_completo }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3" id="cliente-otro-input-container" style="display: none;">
                <label class="form-label">Nombre del Cliente (Otro)</label>
                <input name="cliente_otro_nombre" id="cliente-otro-input" class="form-control">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Vendedor (Opcional)</label>
                <select name="empleado_id" class="form-control">
                    <option value="">Seleccione un vendedor...</option>
                    {% for empleado in empleados %}
                        <option value="{{ empleado.id }}">{{ empleado.nombre_completo }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">MÃ©todo de Pago (*)</label>
                <select name="metodo_pago" class="form-control" required>
                    <option value="">Seleccione...</option>
                    {% for code, label in metodos_pago %}
                        <option value="{{ code }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="esta_pagada" name="esta_pagada" checked>
                <label class="form-check-label" for="esta_pagada">Venta Pagada</label>
            </div>
        </div>

        <div class="col-md-8">
            <h4>2. Detalles de Venta</h4>
            
            <table class="table table-striped table-bordered" id="detalle-venta-table">
                <thead>
                    <tr>
                        <th>Producto (*)</th>
                        <th>Cantidad (*)</th>
                        <th>Precio Unitario</th>
                        <th>Desc. (%)</th>
                        <th>Subtotal</th>
                        <th>Eliminar</th>
                    </tr>
                </thead>
                <tbody id="formset-container">
                    {{ formset.management_form }}
                    
                    {% for form in formset %}
                        <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <td>
                                {{ form.producto }}
                                {% if form.producto.errors %}
                                    <small class="text-danger">{{ form.producto.errors.0 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.cantidad_vendida }}
                                {% if form.cantidad_vendida.errors %}
                                    <small class="text-danger">{{ form.cantidad_vendida.errors.0 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.precio_unitario }}
                                {% if form.precio_unitario.errors %}
                                    <small class="text-danger">{{ form.precio_unitario.errors.0 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.descuento_porcentaje }}
                                {% if form.descuento_porcentaje.errors %}
                                    <small class="text-danger">{{ form.descuento_porcentaje.errors.0 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <input type="text" class="form-control subtotal-display" value="0.00" readonly>
                            </td>
                            <td>
                                {{ form.DELETE }}
                                <button type="button" class="btn btn-sm btn-outline-danger remove-form-row">X</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <button type="button" class="btn btn-sm btn-info" id="add-form-row">AÃ±adir Producto</button>
            
            {% if formset.non_form_errors %}
                <p class="mt-2 text-danger">
                    {% for error in formset.non_form_errors %}{{ error }}{% endfor %}
                </p>
            {% endif %}
        </div>
    </div>
    
    <hr>
    <button class="btn btn-primary" type="submit">Guardar Venta</button>
    <a href="{% url 'ver_ventas' %}" class="btn btn-secondary">Cancelar</a>
</form>

<template id="empty-form-template">
    <tr class="formset-row" data-form-index="__prefix__">
        {% for hidden in formset.empty_form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        
        <td>
            {{ formset.empty_form.producto }}
        </td>
        <td>
            {{ formset.empty_form.cantidad_vendida }}
        </td>
        <td>
            {{ formset.empty_form.precio_unitario }}
        </td>
        <td>
            {{ formset.empty_form.descuento_porcentaje }}
        </td>
        <td>
            <input type="text" class="form-control subtotal-display" value="0.00" readonly>
        </td>
        <td>
            {{ formset.empty_form.DELETE }}
            <button type="button" class="btn btn-sm btn-outline-danger remove-form-row">X</button>
        </td>
    </tr>
</template>


<script>
// Datos de productos desde Django
const PRODUCTOS_DATA = {{ productos_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Script iniciado');
    
    const tableBody = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form-row');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    
    // --- OBTENER LA PLANTILLA ---
    const emptyFormTemplate = document.getElementById('empty-form-template');
    
    if (!tableBody || !addButton || !totalFormsInput || !emptyFormTemplate) {
        console.error('âŒ Faltan elementos bÃ¡sicos (tableBody, addButton, totalFormsInput o emptyFormTemplate)');
        return;
    }
    
    let totalForms = parseInt(totalFormsInput.value);
    console.log('ðŸ“Š Total forms inicial:', totalForms);

    // ============================================
    // LÃ³gica para Cliente AnÃ³nimo/Otro
    // ============================================
    const clienteSelect = document.getElementById('cliente-select');
    const clienteOtroContainer = document.getElementById('cliente-otro-input-container');
    const clienteOtroInput = document.getElementById('cliente-otro-input');

    if (clienteSelect && clienteOtroContainer && clienteOtroInput) {
        clienteSelect.addEventListener('change', function() {
            if (this.value === 'otro') {
                clienteOtroContainer.style.display = 'block';
                clienteOtroInput.setAttribute('required', 'required');
            } else {
                clienteOtroContainer.style.display = 'none';
                clienteOtroInput.removeAttribute('required');
                clienteOtroInput.value = ''; 
            }
        });
    }
    
    // ============================================
    // FUNCIÃ“N: Obtener precio de producto
    // ============================================
    function getProductPrice(productId) {
        if (!productId) return '0.00';
        const product = PRODUCTOS_DATA.find(p => String(p.id) === String(productId));
        return product ? product.precio_venta : '0.00';
    }
    
    // ============================================
    // FUNCIÃ“N: Calcular subtotal
    // ============================================
    function calcularSubtotal(row) {
        const cantidadInput = row.querySelector('input[name$="-cantidad_vendida"]');
        const precioInput = row.querySelector('input[name$="-precio_unitario"]');
        const descuentoInput = row.querySelector('input[name$="-descuento_porcentaje"]');
        const subtotalDisplay = row.querySelector('.subtotal-display');
        
        if (!cantidadInput || !precioInput || !descuentoInput || !subtotalDisplay) return;
        
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precio = parseFloat(precioInput.value) || 0;
        const descuento = parseFloat(descuentoInput.value) || 0;
        
        const base = cantidad * precio;
        const subtotal = base * (1 - descuento / 100);
        
        subtotalDisplay.value = subtotal.toFixed(2);
    }
    
    // ============================================
    // FUNCIÃ“N: Actualizar precio cuando cambia producto
    // ============================================
    function onProductoChange(event) {
        const select = event.target;
        const productoId = select.value;
        const row = select.closest('.formset-row');
        const precioInput = row.querySelector('input[name$="-precio_unitario"]');
        
        if (!precioInput) return;
        
        const precio = getProductPrice(productoId);
        precioInput.value = precio;
        calcularSubtotal(row);
    }
    
    // ============================================
    // FUNCIÃ“N: Adjuntar eventos a una fila
    // ============================================
    function adjuntarEventos(row) {
        // Select de producto
        const productoSelect = row.querySelector('select[name$="-producto"]');
        if (productoSelect) {
            productoSelect.removeEventListener('change', onProductoChange);
            productoSelect.addEventListener('change', onProductoChange);
        }
        
        // Inputs para calcular subtotal
        const inputsCalculo = row.querySelectorAll('input[name$="-cantidad_vendida"], input[name$="-descuento_porcentaje"], input[name$="-precio_unitario"]');
        inputsCalculo.forEach(input => {
             input.addEventListener('input', () => calcularSubtotal(row));
        });
        
        // BotÃ³n eliminar
        const removeBtn = row.querySelector('.remove-form-row');
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    // Si es una fila existente, la marca para borrar
                    deleteInput.checked = true;
                    row.style.display = 'none';
                    console.log('ðŸ—‘ï¸ Fila marcada para eliminar');
                } else {
                    // Si es una fila nueva no guardada, la elimina del DOM
                    row.remove();
                    console.log('ðŸ—‘ï¸ Fila nueva eliminada del DOM');
                }
            });
        }
    }
    
    // ============================================
    // Adjuntar eventos a filas existentes (al cargar)
    // ============================================
    tableBody.querySelectorAll('.formset-row').forEach(row => {
        adjuntarEventos(row);
        calcularSubtotal(row);
    });
    
    // ============================================
    // BOTÃ“N: AÃ±adir nueva fila (CORREGIDO)
    // ============================================
    addButton.addEventListener('click', function() {
        console.log('âž• AÃ±adiendo nueva fila...');
        
        // 1. Obtener el HTML de la plantilla
        const templateHtml = emptyFormTemplate.innerHTML;
        
        // 2. Reemplazar el prefijo
        const nuevoHtml = templateHtml.replace(/__prefix__/g, totalForms);
        
        // 3. Crear el nuevo elemento <tr>
        const nuevaFila = document.createElement('tr');
        nuevaFila.innerHTML = nuevoHtml;
        nuevaFila.classList.add('formset-row');
        
        // 4. Adjuntar la fila a la tabla
        tableBody.appendChild(nuevaFila);
        
        // 5. Adjuntar eventos a la *nueva* fila
        adjuntarEventos(nuevaFila);
        
        // 6. Incrementar contadores
        totalForms++;
        totalFormsInput.value = totalForms;
        
        console.log(`âœ… Nueva fila aÃ±adida. Total: ${totalForms}`);
    });
    
    console.log('âœ… Script completado');
});
</script>

{% endblock %}